<!doctype html>
<html lang="zh-CN">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

  
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />

  
  
  

  <link rel="stylesheet" href="/css/mobi.css-3.1.1/dist/mobi.min.css">
<link rel="stylesheet" href="/css/caomei1.2.1/style.css">
<link rel="stylesheet" href="/css/theme.css">

  
    <meta name="keywords" content="AST, UglifyJS, JavaScript" />
  

  
    <link rel="alternate" href="/atom.xml" title="流浪小猫的博客" type="application/atom+xml" />
  

  
    <link rel="shortcut icon" href="/favicon.ico">
  

  <title>抽象语法树在 JavaScript 中的应用 - 流浪小猫的博客</title>
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head>

  <body class="theme-body">
    <div class="flex-center theme-header-wrapper">
  <div class="container flex-left units-gap theme-header-container">
    <a href="/" class="unit-0 theme-header-icon theme-icon-link" title="首页">
      <i class="czs-home-l"></i>
    </a>
    <div class="flex-center text-center flex-middle unit theme-header-title theme-header-title-no-transition">
      流浪小猫的博客
    </div>
    <a class="unit-0 theme-header-icon theme-icon-link theme-header-sidebar-icon" href="javascript:void(0);" title="更多">
      <i class="czs-menu-l"></i>
    </a>
  </div>
</div>
<div class="theme-header-placeholder"></div>

    <div class="flex-center">
      <div class="container">
        <article>
  <h1 class="text-center">
    抽象语法树在 JavaScript 中的应用
  </h1>
  <div class="text-center top-gap">
    <div class="text-small text-muted">
  <time datetime="2014-10-08T00:00:00+08:00">
    2014-10-08
  </time>
  <span class="theme-separator">·</span>
  <i class="czs-user-l"></i>
  <a class="text-muted theme-text-no-decoration" href="https://github.com/xcatliu">xcatliu</a>
  <span class="theme-separator">·</span>
  <i class="czs-bookmark-l"></i>
  <a class="text-muted theme-text-no-decoration" href="/categories/Programmer/">Programmer</a>
  <span class="theme-comment-count-container theme-hide theme-comment-count-container-transparent">
    <span class="theme-separator">·</span>
    <i class="czs-comment-l"></i>
    <a class="text-muted theme-text-no-decoration theme-comment-count" data-disqus-identifier="2014/10/08/abstract_syntax_tree/" href="/2014/10/08/abstract_syntax_tree/#disqus_thread"></a>
  </span>
</div>

  </div>
  <div class="top-gap-big">
    <blockquote>
<p>发表在美团技术博客上：<a href="http://tech.meituan.com/abstract-syntax-tree.html" target="_blank" rel="external">http://tech.meituan.com/abstract-syntax-tree.html</a></p>
</blockquote>
<h2 id="抽象语法树是什么"><a href="#抽象语法树是什么" class="headerlink" title="抽象语法树是什么"></a>抽象语法树是什么</h2><blockquote>
<p>在计算机科学中，抽象语法树（Abstract syntax tree 或者缩写为 AST），或者语法树（Syntax tree），是源代码的抽象语法结构的树状表现形式，这里特指编程语言的源代码。树上的每个节点都表示源代码中的一种结构。之所以说语法是「抽象」的，是因为这里的语法并不会表示出真实语法中出现的每个细节。<sup><a href="http://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank" rel="external">1</a></sup></p>
</blockquote>
<p>果然比较抽象，不如先看几个例子：</p>
<h2 id="抽象语法树举例"><a href="#抽象语法树举例" class="headerlink" title="抽象语法树举例"></a>抽象语法树举例</h2><pre class=" language-js"><code class="language-js">foo <span class="token operator">=</span> <span class="token string">'hello world'</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/*
    +-------------+             
    |  assign(=)  |             
    +-------------+             
       X        X               
      X          X              
+-------+    +-----------------+
|  foo  |    |  'hello world'  |
+-------+    +-----------------+
*/</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>foo <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  bar <span class="token operator">=</span> <span class="token string">'hello world'</span><span class="token punctuation">;</span>
  <span class="token function">alert</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/*
                       +------+                                    
                       |  if  |                                    
                       +------+                                    
                        X    X                                     
                      X        X                                   
         +--------------+    +-------------+                       
         |  equal(===)  |    |  if_body    |                       
         +--------------+    +-------------+                       
         X        X              X         X                       
       X         X                X          X                     
+-------+   +--------+    +-------------+   +------------+         
|  foo  |   |  true  |    |  assign(=)  |   |  alert()   |         
+-------+   +--------+    +-------------+   +------------+         
                             X        X                  X         
                           X            X                  X       
                       +-------+   +-----------------+    +-------+
                       |  bar  |   |  'hello world'  |    |  bar  |
                       +-------+   +-----------------+    +-------+
*/</span>
</code></pre>
<p>从上述两个例子可以看出，抽象语法树是将源代码根据其语法结构，省略一些细节（比如：括号没有生成节点），抽象成树形表达。</p>
<p>抽象语法树在计算机科学中有很多应用，比如编译器、IDE、压缩优化代码等。下面介绍一下抽象语法树在 JavaScript 中的应用。</p>
<h2 id="JavaScript-抽象语法树"><a href="#JavaScript-抽象语法树" class="headerlink" title="JavaScript 抽象语法树"></a>JavaScript 抽象语法树</h2><p>构造 JavaScript 抽象语法树有多种工具，比如 <a href="https://github.com/v8/v8/blob/master/src/ast/ast.h" target="_blank" rel="external">V8</a>、<a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Parser_API" target="_blank" rel="external">SpiderMonkey</a>、<a href="http://lisperator.net/uglifyjs/" target="_blank" rel="external">UglifyJS</a> 等，这里重点介绍 UglifyJS。</p>
<h3 id="UglifyJS"><a href="#UglifyJS" class="headerlink" title="UglifyJS"></a>UglifyJS</h3><p>UglifyJS<sup><a href="http://lisperator.net/uglifyjs/" target="_blank" rel="external">2</a></sup> 是使用最广的 JavaScript 压缩工具之一，而且自身也是用 JavaScript 写的，使用它的方法很简单（需要 <a href="http://nodejs.org/" target="_blank" rel="external">Node.js</a> 环境）：</p>
<p>首先全局安装：</p>
<pre class=" language-shell"><code class="language-shell">[sudo ]npm install -g uglify-js
</code></pre>
<p>然后就可以使用了：</p>
<pre class=" language-shell"><code class="language-shell">uglifyjs -m srcFileName.js -o destFileName.min.js
</code></pre>
<p>关于 UglifyJS 的用法这里就不多介绍了，我们要做的是一些更有趣的事情。</p>
<h3 id="UglifyJS-Tools"><a href="#UglifyJS-Tools" class="headerlink" title="UglifyJS Tools"></a>UglifyJS Tools</h3><p>UglifyJS 提供了一些工具用于分析 JavaScript 代码，包括：</p>
<ul>
<li>parser，把 JavaScript 代码解析成抽象语法树</li>
<li>code generator，通过抽象语法树生成代码</li>
<li>mangler，混淆 JavaScript 代码</li>
<li>scope analyzer，分析变量定义的工具</li>
<li>tree walker，遍历树节点</li>
<li>tree transformer，改变树节点</li>
</ul>
<h3 id="生成抽象语法树"><a href="#生成抽象语法树" class="headerlink" title="生成抽象语法树"></a>生成抽象语法树</h3><p>使用 UglifyJS 生成抽象语法树很简单：</p>
<p>首先安装 UglifyJS 为 npm 包：</p>
<pre class=" language-shell"><code class="language-shell">npm install uglify-js --save-dev
</code></pre>
<p>然后使用 parse 方法即可：</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> UglifyJS <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'uglify-js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> ast <span class="token operator">=</span> UglifyJS<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'function sum(foo, bar){ return foo + bar; }'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>这样生成的 ast 即为那一段代码的抽象语法树。那么我们怎么使用呢？</p>
<h3 id="使用-mangler-压缩代码"><a href="#使用-mangler-压缩代码" class="headerlink" title="使用 mangler 压缩代码"></a>使用 mangler 压缩代码</h3><p>使用 mangler 可以通过将局部变量都缩短成一个字符来压缩代码。</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> UglifyJS <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'uglify-js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> ast <span class="token operator">=</span> UglifyJS<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'function sum(foo, bar){ return foo + bar; }'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ast<span class="token punctuation">.</span><span class="token function">figure_out_scope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ast<span class="token punctuation">.</span><span class="token function">mangle_names</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span><span class="token function">print_to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// function sum(a,b){return a+b}</span>
</code></pre>
<h3 id="使用-walker-遍历抽象语法树"><a href="#使用-walker-遍历抽象语法树" class="headerlink" title="使用 walker 遍历抽象语法树"></a>使用 walker 遍历抽象语法树</h3><p>使用 walker 可以遍历抽象语法树，这种遍历是深度遍历。</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> UglifyJS <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'uglify-js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> ast <span class="token operator">=</span> UglifyJS<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'function sum(foo, bar){ return foo + bar; }'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ast<span class="token punctuation">.</span><span class="token function">figure_out_scope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ast<span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UglifyJS<span class="token punctuation">.</span>TreeWalker</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">print_to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/*
function sum(foo,bar){return foo+bar}
function sum(foo,bar){return foo+bar}
sum
foo
bar
return foo+bar
foo+bar
foo
bar
*/</span>
</code></pre>
<p>UglifyJS 已经提供了直接压缩代码的脚本，walker 看上去貌似也没啥用，那么这些工具有什么使用场景呢？</p>
<h2 id="抽象语法树的应用"><a href="#抽象语法树的应用" class="headerlink" title="抽象语法树的应用"></a>抽象语法树的应用</h2><h3 id="利用抽象语法树重构-JavaScript-代码"><a href="#利用抽象语法树重构-JavaScript-代码" class="headerlink" title="利用抽象语法树重构 JavaScript 代码"></a>利用抽象语法树重构 JavaScript 代码</h3><p>假如我们有重构 JavaScript 的需求，它们就派上用场啦。</p>
<p>下面考虑这样一个需求：</p>
<p>我们知道，<code>parseInt</code> 用于将字符串变成整数，但是它有第二个参数，表示以几进制识别字符串，若没有传第二个参数，则会自行判断，比如：</p>
<pre class=" language-js"><code class="language-js"><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">'10.23'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 10            转换成正整数</span>
<span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">'10abc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 10            忽略其他字符</span>
<span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">'10'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 10            转换成十进制</span>
<span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">'10'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 2             转换成二进制</span>
<span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">'0123'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 83 or 123     不同浏览器不一样，低版本浏览器会转换成八进制</span>
<span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">'0x11'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 17            转换成十六进制</span>
</code></pre>
<p>因为有一些情况是和我们预期不同的，所以建议任何时候都加上第二个参数。</p>
<p>下面希望有一个脚本，查看所有 <code>parseInt</code> 有没有第二个参数，没有的话加上第二个参数 10，表示以十进制识别字符串。</p>
<p>使用 UglifyJS 可以实现此功能：</p>
<pre class=" language-js"><code class="language-js">#<span class="token operator">!</span> <span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node

<span class="token keyword">var</span> U2 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"uglify-js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">replace_parseint</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> ast <span class="token operator">=</span> U2<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// accumulate `parseInt()` nodes in this array</span>
    <span class="token keyword">var</span> parseint_nodes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    ast<span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">U2<span class="token punctuation">.</span>TreeWalker</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token keyword">instanceof</span> <span class="token class-name">U2<span class="token punctuation">.</span>AST_Call</span>
            <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>expression<span class="token punctuation">.</span><span class="token function">print_to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'parseInt'</span>
            <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>args<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            parseint_nodes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// now go through the nodes backwards and replace code</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> parseint_nodes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">--</span>i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> node <span class="token operator">=</span> parseint_nodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> start_pos <span class="token operator">=</span> node<span class="token punctuation">.</span>start<span class="token punctuation">.</span>pos<span class="token punctuation">;</span>
        <span class="token keyword">var</span> end_pos <span class="token operator">=</span> node<span class="token punctuation">.</span>end<span class="token punctuation">.</span>endpos<span class="token punctuation">;</span>
        node<span class="token punctuation">.</span>args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">U2<span class="token punctuation">.</span>AST_Number</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            value<span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> replacement <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">print_to_string</span><span class="token punctuation">(</span><span class="token punctuation">{</span> beautify<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        code <span class="token operator">=</span> <span class="token function">splice_string</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> start_pos<span class="token punctuation">,</span> end_pos<span class="token punctuation">,</span> replacement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> code<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">splice_string</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> begin<span class="token punctuation">,</span> end<span class="token punctuation">,</span> replacement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> begin<span class="token punctuation">)</span> <span class="token operator">+</span> replacement <span class="token operator">+</span> str<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// test it</span>

<span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>foo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">'12342'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token string">'0012'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">replace_parseint</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/*
function test() {
    if (foo) {
      parseInt("12342", 10);
    }
    parseInt('0012', 3);
}
*/</span>
</code></pre>
<p>在这里，使用了 walker 找到 <code>parseInt</code> 调用的地方，然后检查是否有第二个参数，没有的话，记录下来，之后根据每个记录，用新的包含第二个参数的内容替换掉原内容，完成代码的重构。</p>
<p>也许有人会问，这种简单的情况，用正则匹配也可以方便的替换，干嘛要用抽象语法树呢？</p>
<p>答案就是，<strong>抽象语法树是通过分析语法实现的，有一些正则无法（或者很难）做到的优势，比如，parseInt() 整个是一个字符串，或者在注释中，此种情况会被正则误判</strong>：</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token string">'parseInt("12345")'</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// parseInt("12345");</span>
</code></pre>
<h3 id="抽象语法树在美团中的应用"><a href="#抽象语法树在美团中的应用" class="headerlink" title="抽象语法树在美团中的应用"></a>抽象语法树在美团中的应用</h3><p>在美团前端团队，我们使用 YUI 作为前端底层框架，之前面临的一个实际问题是，模块之间的依赖关系容易出现疏漏。比如：</p>
<pre class=" language-js"><code class="language-js">YUI<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'mod1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>Y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Y<span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token string">'#button1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">simulate</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Y<span class="token punctuation">.</span>Array<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Y<span class="token punctuation">.</span>mod1 <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/**/</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    requires<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">'node'</span><span class="token punctuation">,</span>
        <span class="token string">'array-extras'</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
YUI<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'mod2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>Y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Y<span class="token punctuation">.</span><span class="token function">mod1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Y.io(uri, config);</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    requires<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">'mod1'</span><span class="token punctuation">,</span>
        <span class="token string">'io'</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>以上代码定义了两个模块，其中 <code>mod1</code> 模拟点击了一下 <code>id</code> 为 <code>button1</code> 的元素，执行了 <code>Y.Array.each</code>，然后定义了方法 <code>Y.mod1</code>，最后声明了依赖 <code>node</code> 和 <code>array-extras</code>；<code>mod2</code> 执行了 <code>mod1</code> 中定义的方法，而<code>Y.io</code> 被注释了，最后声明了依赖 <code>mod1</code> 和 <code>io</code>。</p>
<p>此处 <code>mod1</code> 出现了两个常见错误，一个是 <code>simulate</code> 是 <code>Y.Node.prototype</code> 上的方法，容易忘掉声明依赖 <code>node-event-simulate</code><sup><a href="http://yuilibrary.com/yui/docs/api/files/node_js_node-event-simulate.js.html#l1" target="_blank" rel="external">3</a></sup>，另一个是 <code>Y.Array</code> 上只有部分方法需要依赖 <code>array-extras</code>，故此处多声明了依赖 <code>array-extras</code><sup><a href="http://yuilibrary.com/yui/docs/api/classes/Array.html#method_each" target="_blank" rel="external">4</a></sup>；<code>mod2</code> 中添加注释后，容易忘记删除原来写的依赖 <code>io</code>。</p>
<p>故正确的依赖关系应该如下：</p>
<pre class=" language-js"><code class="language-js">YUI<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'mod1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>Y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Y<span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token string">'#button1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">simulate</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Y<span class="token punctuation">.</span>Array<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Y<span class="token punctuation">.</span>mod1 <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/**/</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    requires<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">'node'</span><span class="token punctuation">,</span>
        <span class="token string">'node-event-simulate'</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
YUI<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'mod2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>Y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Y<span class="token punctuation">.</span><span class="token function">mod1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Y.io(uri, config);</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    requires<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">'mod1'</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>为了使模块依赖关系的检测自动化，我们创建了模块依赖关系检测工具，它利用抽象语法树，分析出定义了哪些接口，使用了哪些接口，然后查找这些接口应该依赖哪些模块，进而找到模块依赖关系的错误，大致的过程如下：</p>
<ol>
<li>找到代码中模块定义（<code>YUI.add</code>）的部分</li>
<li>分析每个模块内函数定义，变量定义，赋值语句等，找出符合要求（以 <code>Y</code> 开头）的输出接口（如 <code>mod1</code> 中的 <code>Y.mod1</code>）</li>
<li>生成「接口 - 模块」对应关系</li>
<li>分析每个模块内函数调用，变量使用等，找出符合要求的输入接口（如 <code>mod2</code> 中的 <code>Y.one</code>，<code>Y.Array.each</code>，<code>Y.mod1</code>）</li>
<li>通过「接口 - 模块」对应关系，找到此模块应该依赖哪些其他模块</li>
<li>分析 requires 中是否有错误</li>
</ol>
<p>使用此工具，保证每次提交代码时，依赖关系都是正确无误的，它帮助我们实现了模块依赖关系检测的自动化。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>抽象语法树在计算机领域中应用广泛，以上仅讨论了抽象语法树在 JavaScript 中的一些应用，期待更多的用法等着大家去尝试和探索。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol>
<li><a href="http://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank" rel="external">Wikipedia AST</a></li>
<li><a href="http://lisperator.net/uglifyjs/" target="_blank" rel="external">UglifyJS</a></li>
<li><a href="http://yuilibrary.com/yui/docs/api/files/node_js_node-event-simulate.js.html#l1" target="_blank" rel="external">node-event-simulate</a></li>
<li><a href="http://yuilibrary.com/yui/docs/api/classes/Array.html#method_each" target="_blank" rel="external">Y.Array.each</a></li>
</ol>

  </div>
</article>
<blockquote class="top-gap-big"> <p> 本文遵循 <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" class"text-muted">CC BY-ND-ND 3.0</a> 协议，转载请注明原作者，禁止商用，禁止演绎。 </p> </blockquote>
<div class="top-gap-big text-center text-muted">
  <small>
    <i class="czs-tag-l"></i>
    <a class="text-muted" href="/tags/AST/">AST</a> , <a class="text-muted" href="/tags/UglifyJS/">UglifyJS</a> , <a class="text-muted" href="/tags/JavaScript/">JavaScript</a>
  </small>
</div>


  <div id="disqus_thread" class="top-gap-big"></div>
  <script>
    var langMap = {
      en: 'en',
      'zh-CN': 'zh'
    };
    var disqus_config = function () {
      this.language = langMap['zh-CN'] || langMap['en'];
      this.page.url = 'http://blog.xcatliu.com/2014/10/08/abstract_syntax_tree/';
      this.page.identifier = '2014/10/08/abstract_syntax_tree/';
      this.page.title = '抽象语法树在 JavaScript 中的应用';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = '//xcatliu.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


        <hr class="top-gap-big"></hr>
<p class="text-center">
  <small class="text-muted">
    &copy;
    
      2012 -
    
    <span itemprop="copyrightYear">2020</span>
    <i class="czs-heart" style="color:red;"></i>
    <span itemprop="copyrightHolder">xcatliu</span>

    <br/>

    由 <a class="text-muted" href="https://hexo.io" title="Hexo">Hexo</a> 强力驱动
    <span class="theme-separator">·</span>
    主题
    <a class="text-muted" href="https://github.com/xcatliu/hexo-theme-milk">Milk</a>
  </small>
</p>

      </div>
      <div class="theme-sidebar-mask theme-hide"></div>
<aside class="theme-sidebar-wrapper">
  <div class="container flex-left units-gap theme-header-container">
    
    <a class="unit-0 theme-icon-link" href="/archives" title="归档">
      <i class="czs-folder-l"></i>
    </a>
  
    <a class="unit-0 theme-icon-link" href="/categories" title="分类">
      <i class="czs-bookmark-l"></i>
    </a>
  
    <a class="unit-0 theme-icon-link" href="/tags" title="标签">
      <i class="czs-tag-l"></i>
    </a>
  
    <div class="unit"></div>
  
    <a class="unit-0 theme-icon-link" href="http://xcatliu.com" title="关于我">
      <i class="czs-user-l"></i>
    </a>
  

  </div>
  <div class="container">
    
          <h2>流浪小猫的博客</h2>
          
          <p class="top-gap-0 text-muted">记录我的成长点滴</p>
          
          <div class="flex-left flex-middle top-gap">
            <img alt="Avatar" height="24" src="/assets/about/xcatliu_512.png"/>
            <span class="theme-sidebar-author">xcatliu</span>
          </div>
          
          <p>欢迎访问流浪小猫的博客，这里搜集了我的技术文章和生活感悟，希望能够与您一起交流，共同成长。</p>
          
          <p class="theme-sidebar-social">
            
    <a class="unit-0 theme-icon-link" href="https://github.com/xcatliu" title="GitHub">
      <i class="czs-github"></i>
    </a>
  
    <a class="unit-0 theme-icon-link" href="https://www.v2ex.com/member/xcatliu" title="V2EX">
      <i class="czs-v2ex"></i>
    </a>
  
    <a class="unit-0 theme-icon-link" href="https://twitter.com/xcatliu" title="Twitter">
      <i class="czs-twitter"></i>
    </a>
  
    <a class="unit-0 theme-icon-link" href="mailto:xcatliu@gmail.com" title="Gmail">
      <i class="czs-message-l"></i>
    </a>
  
    <a class="unit-0 theme-icon-link" href="/atom.xml" title="RSS 订阅">
      <i class="czs-rss"></i>
    </a>
  

          </p>
          
          <h5>友情链接</h5>
          <p class="text-muted">
            <small>
              <ul class="theme-list-style-none">
                <li><a class="text-muted" href="http://chuangzaoshi.com/">创造狮</a></li><li><a class="text-muted" href="https://blog.jamespan.me/">James Pan's Blog</a></li><li><a class="text-muted" href="/links">More</a></li>
              </ul>
            </small>
          </p>
          
  </div>
</aside>

    </div>
    <script src="/js/theme.js"></script>
    
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-45256157-6', 'auto');
    ga('send', 'pageview');
  </script>


    
  <script id="dsq-count-scr" src="//xcatliu.disqus.com/count.js" async></script>

  </body>
</html>
